<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>LanguagePrep Ireland - Italian</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üáÆüáπ</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    /* === CAMBIO DE LOOK: ROJO ITALIANO === */
    :root { 
      --primary: #D32F2F; /* Rojo Intenso (Principal) */
      --primary-dark: #B71C1C; /* Rojo Oscuro (Hover) */
      --secondary: #008C45; /* Verde Bandera (Secundario) */
      --bg: #fff5f5; /* Fondo ligeramente rosado muy suave */
      --text: #1e293b; 
    }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); min-height: 90vh; display: flex; flex-direction: column; }
    
    /* HEADER */
    header { text-align: center; margin-bottom: 20px; }
    h1 { margin: 0; color: var(--primary); font-size: 2.2rem; letter-spacing: -1px; }
    .subtitle { color: var(--secondary); margin-top: 5px; font-size: 0.95rem; font-weight: 700; }
    
    .info-toggle { background: #ffe4e6; color: var(--primary-dark); border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; cursor: pointer; margin-top: 15px; display: inline-flex; align-items: center; gap: 5px; }
    .info-box { display: none; background: #fff1f2; border: 1px solid #fecdd3; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: left; font-size: 0.9rem; color: #334155; }

    /* TABS SYSTEM */
    .tabs-container { display: flex; gap: 10px; margin-bottom: 25px; padding: 5px; background: #f1f5f9; border-radius: 15px; }
    .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; transition: 0.2s; color: #64748b; background: transparent; }
    .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

    /* SECTION: CONVERSATION STYLES */
    .level-selector { display: flex; background: #f8fafc; padding: 5px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
    .level-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: 0.3s; font-size: 0.9rem; color: #64748b; background: transparent; }
    .level-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .level-btn.hl.active { color: var(--secondary); }

    /* BOT√ìN MOCK EXAM EN ROJO FERRARI */
    .mock-btn { width: 100%; padding: 15px; margin-bottom: 25px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border: none; border-radius: 12px; font-weight: 800; font-size: 1.1rem; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3); transition: transform 0.2s; }
    .mock-btn:hover { transform: scale(1.02); }

    .topic-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 25px; }
    .topic-btn { padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; background: white; cursor: pointer; font-size: 0.85rem; font-weight: 600; text-align: center; color: #475569; transition: 0.2s; }
    .topic-btn:hover { background: #f1f5f9; }
    .topic-btn.active { border-color: var(--primary); background: #fef2f2; color: var(--primary); transform: scale(1.02); }

    /* Tarjeta de pregunta con borde verde para contraste */
    .question-card { background: #fef2f2; border-left: 5px solid var(--secondary); padding: 25px; border-radius: 0 12px 12px 0; margin-bottom: 20px; }
    
    /* SECTION: ROLEPLAY STYLES */
    .rp-selector { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 20px; scrollbar-width: none; }
    .rp-btn-select { min-width: 130px; padding: 10px; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 50px; font-size: 0.85rem; font-weight: 700; cursor: pointer; color: #475569; text-align: center; }
    .rp-btn-select.active { background: var(--primary); color: white; border-color: var(--primary); }
    
    .chat-container { flex-grow: 1; background: #f8fafc; border-radius: 15px; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; border: 1px solid #e2e8f0; max-height: 500px; min-height: 300px; margin-bottom: 15px; }
    .bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 0.95rem; line-height: 1.5; }
    .ex { align-self: flex-start; background: white; border: 1px solid #e2e8f0; color: #334155; border-bottom-left-radius: 4px; }
    
    /* Burbuja del estudiante en ROJO */
    .st { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
    .rp-context { font-size: 0.85rem; color: #64748b; margin-bottom: 10px; font-style: italic; text-align: center; }
    
    .rp-controls { display: flex; gap: 10px; border-top: 1px solid #e2e8f0; padding-top: 15px; }
    .rp-input { flex: 1; padding: 12px 20px; border-radius: 50px; border: 2px solid #e2e8f0; background: white; font-size: 1rem; outline: none; }
    .rp-input:focus { border-color: var(--primary); }
    .btn-send { background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
    .btn-send:disabled { background: #cbd5e1; }
    
    .next-audio-btn { width: 100%; padding: 12px; background: var(--secondary); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; margin-bottom: 10px; display: none; }
    .feedback-rp { font-size: 0.9em; background: #fffbeb; color: #92400e; padding: 10px; border-radius: 10px; border-left: 4px solid #f59e0b; margin-top: 5px; }
    .model-answer-btn { background: none; border: none; color: #64748b; font-size: 0.8rem; cursor: pointer; text-decoration: underline; display: block; margin: 0 auto; }

    /* SHARED COMPONENTS */
    .audio-btn { margin-top: 15px; background: white; border: 1px solid #e2e8f0; padding: 8px 16px; border-radius: 50px; font-size: 0.9rem; font-weight: 600; cursor: pointer; color: var(--text); }
    textarea { width: 100%; border: 2px solid #e2e8f0; border-radius: 15px; padding: 15px; min-height: 120px; box-sizing: border-box; font-size: 1rem; margin-bottom: 15px; font-family: inherit; }
    textarea:focus { border-color: var(--secondary); outline: none; }
    .btn-main { width: 100%; padding: 16px; background: var(--text); color: white; border: none; border-radius: 15px; font-weight: 800; cursor: pointer; font-size: 1.1rem; }
    .btn-main:disabled { opacity: 0.5; cursor: wait; }

    /* RESULT & FOOTER */
    #result { margin-top: 30px; display: none; }
    .student-response-box { background: #f1f5f9; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #94a3b8; font-style: italic; color: #475569; }
    .feedback-box { padding: 25px; border-radius: 15px; background: #fff; border: 1px solid #e2e8f0; }
    .error-item { margin-bottom: 15px; padding: 15px; background: #fff1f2; border-radius: 10px; border-left: 4px solid #ef4444; }

    .footer-section { margin-top: auto; padding: 40px 20px 20px; border-top: 1px solid #e2e8f0; background: #fafafa; border-radius: 20px; text-align: center; }
    .profile-img { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin-bottom: 15px; }
    .bio-text { max-width: 600px; margin: 0 auto 25px auto; font-size: 0.95rem; line-height: 1.6; color: #475569; text-align: justify; }
    .revolut-btn { background: #000; color: white; text-decoration: none; padding: 14px 28px; border-radius: 50px; font-weight: 700; display: inline-flex; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: 0.2s; }
    .revolut-btn:hover { transform: translateY(-2px); }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>
      <a href="../" style="text-decoration: none; color: inherit; cursor: pointer;">
        LanguagePrep Ireland
      </a>
    </h1>
    <p class="subtitle">Module: Leaving Cert Italian (Oral)</p>
    
    <button class="info-toggle" onclick="toggleInfo()">‚ÑπÔ∏è Instructions / Istruzioni</button>
    <div id="infoBox" class="info-box">
      <strong>Instructions:</strong>
      <ul>
        <li>üó£Ô∏è <strong>General Conversation:</strong> Use the "Conversation" tab to practice Italian topics.</li>
        <li>üé≠ <strong>Roleplays:</strong> The AI will act as the examiner (reading the lines for you).</li>
        <li>‚å®Ô∏è <strong>Keyboard:</strong> Please use the Italian keyboard on your device for accurate voice typing.</li>
      </ul>
    </div>
  </header>

  <div class="tabs-container">
    <button class="tab-btn active" onclick="switchTab('conv')" id="tabConv">üí¨ Conversation Topics</button>
    <button class="tab-btn" onclick="switchTab('role')" id="tabRole">üé≠ Roleplays</button>
  </div>

  <div id="sectionConversation">
    <div class="level-selector">
      <button class="level-btn active" id="btnOL" onclick="setLevel('OL')">Ordinary Level</button>
      <button class="level-btn hl" id="btnHL" onclick="setLevel('HL')">Higher Level</button>
    </div>

    <button class="mock-btn" onclick="startMockExam()">üé≤ Start Mock Exam (5 Questions)</button>
    <div class="topic-grid" id="topicGrid"></div>

    <div id="exerciseArea" style="display:none;">
      <div class="question-card">
        <div id="qDisplay" style="font-weight: 700;"></div>
        <button class="audio-btn" onclick="speakText()">üîä Listen to Question</button>
      </div>
      <textarea id="userInput" placeholder="Type or use your microphone..."></textarea>
      
      <button onclick="readMyInput()" style="margin: 10px 0; background: #eee; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">
        üëÇ Listen to my answer
      </button>

      <button class="btn-main" id="btnAction" onclick="analyze()">‚ú® Evaluate Answer</button>
    </div>

    <div id="result">
      <div class="student-response-box"><strong>You said:</strong> <span id="userResponseText"></span></div>
      <div class="feedback-box">
        <div id="scoreDisplay" style="font-size: 1.8rem; font-weight: 800; margin-bottom: 15px;"></div>
        <div id="fbES" style="margin-bottom:10px; font-weight:500;"></div>
        <div id="fbEN" style="color:#64748b; font-style:italic;"></div>
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #e2e8f0;">
        <div id="errorsList"></div>
      </div>
      <button id="btnReset" class="btn-main" style="margin-top:20px; background:#e2e8f0; color:var(--text);" onclick="resetApp()">üîÑ Try another topic</button>
    </div>
  </div>

  <div id="sectionRoleplay" style="display:none;">
    <div class="rp-selector">
      <div class="rp-btn-select" onclick="seleccionarRP(1, this)">‚òï 1. Albergo</div>
      <div class="rp-btn-select" onclick="seleccionarRP(2, this)">üé´ 2. Treno</div>
      <div class="rp-btn-select" onclick="seleccionarRP(3, this)">üè® 3. Farmacia</div>
      <div class="rp-btn-select" onclick="seleccionarRP(4, this)">ü©∫ 4. Passaporto</div>
      <div class="rp-btn-select" onclick="seleccionarRP(5, this)">üëï 5. Colloquio</div>
    </div>

    <div id="rpArea" style="display:none;">
      <div class="rp-context" id="rpContext"></div>
      <div class="chat-container" id="rpChat"></div>
      
      <button class="next-audio-btn" id="nextAudioBtn" onclick="proximaIntervencion()">üîä Play Examiner Audio</button>
      
      <div class="rp-controls">
        <input type="text" id="rpInput" class="rp-input" placeholder="Select a roleplay above..." disabled>
        <button class="btn-send" id="rpSendBtn" onclick="enviarRespuestaRP()" disabled>‚û§</button>
      </div>
      <button class="model-answer-btn" onclick="mostrarSugerencia()" id="hintBtn" style="display:none; margin-top:10px;">üí° Show Model Answer</button>
    </div>
  </div>

   <div class="footer-section">
    <img src="../david.PNG" alt="David Mart√≠n" class="profile-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png'">
    
    <h3 style="margin: 0 0 5px 0;">David Mart√≠n</h3>
    <p style="margin: 0 0 20px 0; font-size: 0.9rem; color: #64748b;">Spanish Teacher at <strong>Ardgillan Community College</strong>.</p>
    
    <div class="bio-text">
      <p><em>As a teacher, my goal is to create innovative tools like <strong>LanguagePrep Ireland</strong> to help students excel in their Leaving Cert exams using technology responsibly and effectively.</em></p>
      <p><em>Il mio obiettivo √® creare risorse innovative che incoraggino un uso responsabile ed efficiente della tecnologia nella preparazione degli esami.</em></p>
    </div>

    <a href="https://revolut.me/davidkhy4/pocket/TbT6B5Grkq" target="_blank" class="revolut-btn">‚òï Support this Project</a>
    
    <div style="margin-top: 25px; font-size: 0.85rem; line-height: 1.6; color: #475569;">
      <p>All resources are 100% free.</p>
    </div>

    <div style="margin-top: 35px; border-top: 1px dashed #cbd5e1; padding-top: 25px;">
      <p style="font-size: 0.9rem; font-weight: 700; color: #334155; margin-bottom: 5px;">üêõ Report a Bug / Feedback</p>
      <p style="font-size: 0.75rem; color: #64748b; margin-bottom: 15px;">
        Found a bug in the Italian section? Let me know!<br>
      </p>
      
      <form action="https://formspree.io/f/mjggeygj" method="POST" style="max-width: 450px; margin: 0 auto; text-align: left;">
        
        <textarea name="message" placeholder="Type your suggestion here..." required
                  style="width: 100%; padding: 12px; min-height: 80px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #cbd5e1; box-sizing: border-box; font-family: inherit; font-size: 0.9rem;"></textarea>
        
        <button type="submit" 
                style="width: 100%; background: #475569; color: white; border: none; padding: 10px; border-radius: 50px; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 0.9rem;">
          Send Feedback
        </button>
      </form>
    </div>

  </div>

<script>
// ===========================================
// CONFIGURACI√ìN Y CLAVES (API KEY)
// ===========================================
const parteA = "AIzaSyASf_PIq7es0iPVt"; // <--- PEGA TU CLAVE PARTE A AQU√ç
const parteB = "VUMt8Kn1Ll3qSpQQxg"; // <--- PEGA TU CLAVE PARTE B AQU√ç
const API_KEY = parteA + parteB;

// --- NAVEGACI√ìN DE PESTA√ëAS ---
function toggleInfo() { const b = document.getElementById('infoBox'); b.style.display = b.style.display === 'block' ? 'none' : 'block'; }

function switchTab(tab) {
  document.getElementById('tabConv').className = tab === 'conv' ? 'tab-btn active' : 'tab-btn';
  document.getElementById('tabRole').className = tab === 'role' ? 'tab-btn active' : 'tab-btn';
  document.getElementById('sectionConversation').style.display = tab === 'conv' ? 'block' : 'none';
  document.getElementById('sectionRoleplay').style.display = tab === 'role' ? 'block' : 'none';
}

// ===========================================
// PARTE 1: CONVERSATION (AI - GEMINI) - ITALIAN
// ===========================================
let currentLevel = 'OL';
let currentTopic = null;
let isMockExam = false; 
let mockQuestions = []; 
let mockIndex = 0;      

// Base de datos de Conversaci√≥n (ITALIANO)
const DATA = [
  { title: "1. Mi presento", OL: "Come ti chiami? Quanti anni hai? Quando √® il tuo compleanno?", HL: "Parlami di te. Descrivi la tua personalit√† e i tuoi interessi." },
  { title: "2. La mia famiglia", OL: "Quante persone ci sono nella tua famiglia? Hai fratelli o sorelle?", HL: "Parlami della tua famiglia. Vai d'accordo con i tuoi genitori e fratelli?" },
  { title: "3. La mia casa", OL: "Vivi in una casa o in un appartamento? Descrivi la tua camera.", HL: "Descrivi la tua casa ideale. Cosa ti piace di pi√π della tua casa attuale?" },
  { title: "4. Il mio quartiere", OL: "Cosa c'√® nel tuo quartiere? C'√® un parco o un cinema?", HL: "Parlami della tua zona. Quali sono i vantaggi e gli svantaggi di vivere l√¨?" },
  { title: "5. La scuola", OL: "Ti piace la scuola? Qual √® la tua materia preferita?", HL: "Parlami della tua scuola. Cosa ne pensi del sistema scolastico irlandese?" },
  { title: "6. Passatempi", OL: "Cosa fai nel tempo libero? Ti piace lo sport?", HL: "Parlami dei tuoi hobby. Perch√© √® importante avere interessi fuori dalla scuola?" },
  { title: "7. Il lavoro", OL: "Hai un lavoro part-time? Cosa fai?", HL: "Parlami della tua esperienza lavorativa. Pensi che gli studenti dovrebbero lavorare?" },
  { title: "8. Le vacanze", OL: "Dove sei andato in vacanza l'anno scorso? Ti piace l'Italia?", HL: "Parlami delle tue vacanze. Preferisci il mare o la montagna? Perch√©?" },
  { title: "9. Il futuro", OL: "Cosa farai l'anno prossimo? Vuoi andare all'universit√†?", HL: "Quali sono i tuoi progetti per il futuro? Che lavoro ti piacerebbe fare?" },
  { title: "10. Fine settimana scorso", OL: "Cosa hai fatto il fine settimana scorso?", HL: "Raccontami come hai trascorso lo scorso weekend. Hai fatto qualcosa di speciale?" },
  { title: "11. Prossimo weekend", OL: "Cosa farai il prossimo fine settimana?", HL: "Quali sono i tuoi programmi per il prossimo weekend?" },
  { title: "12. Cibo italiano", OL: "Ti piace il cibo italiano? Qual √® il tuo piatto preferito?", HL: "Cosa ne pensi della cucina italiana? Sai cucinare qualche piatto?" },
  { title: "13. La routine", OL: "A che ora ti svegli la mattina? Cosa fai dopo scuola?", HL: "Descrivi la tua giornata tipica. √à stressante la vita di uno studente?" },
  { title: "14. La moda", OL: "Ti piace fare shopping? Cosa indossi di solito?", HL: "Segui la moda? Pensi che i vestiti firmati siano importanti per i giovani?" },
  { title: "15. Tecnologia", OL: "Hai un telefono nuovo? Usi molto i social media?", HL: "Qual √® il ruolo della tecnologia nella tua vita? Pensi che siamo dipendenti dai telefoni?" }
];

const PAST_Q = ["Cosa hai fatto ieri?", "Dove sei andato l'estate scorsa?", "Come hai festeggiato il tuo compleanno?"];
const FUT_Q = ["Cosa farai domani?", "Dove andrai in vacanza quest'anno?", "Cosa farai dopo gli esami?"];

function setLevel(lvl) { 
    currentLevel = lvl; 
    document.getElementById('btnOL').className = lvl === 'OL' ? 'level-btn active' : 'level-btn'; 
    document.getElementById('btnHL').className = lvl === 'HL' ? 'level-btn hl active' : 'level-btn'; 
    if(currentTopic && !isMockExam) updateQuestion(); 
}

function initConv() { 
    const g = document.getElementById('topicGrid'); 
    DATA.forEach((item) => { 
        const b = document.createElement('button'); 
        b.className = 'topic-btn'; 
        b.innerText = item.title; 
        b.onclick = () => { 
            isMockExam = false; 
            document.querySelectorAll('.topic-btn').forEach(x => x.classList.remove('active')); 
            b.classList.add('active'); 
            currentTopic = item; 
            updateQuestion(); 
        }; 
        g.appendChild(b); 
    }); 
}

function speakText() { 
    const rawHTML = document.getElementById('qDisplay').innerHTML;
    const t = rawHTML.replace(/<[^>]*>/g, " ").replace(/\(PASADO\)|\(FUTURO\)/g, "").replace(/HL|OL/g, "").replace(/[0-9]\./g, ""); 
    
    if ('speechSynthesis' in window) { 
        window.speechSynthesis.cancel(); 
        const u = new SpeechSynthesisUtterance(t); 
        u.lang = 'it-IT'; // ITALIANO
        u.rate = 0.9; 
        window.speechSynthesis.speak(u); 
    } 
}

// === MOCK EXAM ===
function startMockExam() { 
    isMockExam = true; 
    mockIndex = 0; 
    document.querySelectorAll('.topic-btn').forEach(x => x.classList.remove('active')); 
    
    let i = [...Array(DATA.length).keys()].sort(() => Math.random() - 0.5); 
    mockQuestions = [
        DATA[i[0]][currentLevel],
        DATA[i[1]][currentLevel],
        DATA[i[2]][currentLevel],
        PAST_Q[Math.floor(Math.random()*3)] + " (PASSATO)",
        FUT_Q[Math.floor(Math.random()*3)] + " (FUTURO)"
    ];
    
    showMockQuestion();
}

function showMockQuestion() {
    document.getElementById('exerciseArea').style.display = 'block'; 
    document.getElementById('result').style.display = 'none'; 
    document.getElementById('qDisplay').innerHTML = `<strong>Question ${mockIndex + 1}/5:</strong><br><br>${mockQuestions[mockIndex]}`;
    document.getElementById('userInput').value = "";
}

function nextMockQuestion() {
    mockIndex++;
    showMockQuestion();
}

function updateQuestion() { 
    document.getElementById('exerciseArea').style.display = 'block'; 
    document.getElementById('result').style.display = 'none'; 
    document.getElementById('qDisplay').innerHTML = currentTopic[currentLevel]; 
}

function resetApp() { 
    document.getElementById('result').style.display = 'none'; 
    document.getElementById('exerciseArea').style.display = 'block'; 
    if(isMockExam) {
        isMockExam = false;
        document.getElementById('userInput').value = "";
        document.getElementById('qDisplay').innerHTML = "Select a topic or start a new Mock Exam.";
    } else {
        document.getElementById('userInput').value = "";
    }
}

async function analyze() {
  const t = document.getElementById('userInput').value; 
  if(t.length < 5) return alert("Please say something more...");
  
  const b = document.getElementById('btnAction'); 
  b.disabled = true; 
  b.innerText = "‚è≥ Grading...";

  const questionContext = isMockExam ? mockQuestions[mockIndex] : currentTopic[currentLevel];

  // üî• PROMPT ITALIANO üî•
  const prompt = `
    ACT AS: Sympathetic Leaving Cert Italian Oral Examiner (Ireland).
    CONTEXT: The input is RAW VOICE TRANSCRIPTION. It has NO PUNCTUATION and NO CAPITALIZATION.
    
    QUESTION ASKED: "${questionContext}"
    
    CRITICAL INSTRUCTIONS:
    1. IGNORE completely the lack of punctuation.
    2. IGNORE run-on sentences. 
    3. CURRENT LEVEL: ${currentLevel}.
       - If Ordinary Level (OL): Be VERY GENEROUS. If the Italian is understandable, score HIGH (80-100%).
       - If Higher Level (HL): Look for vocabulary/tenses, but still ignore writing mechanics.
    
    TASK:
    Evaluate the student's answer: "${t}"
    
    OUTPUT JSON ONLY:
    {
      "score": (0-100 based on communication),
      "feedback_it": "Brief motivating feedback in Italian",
      "feedback_en": "Brief feedback in English",
      "errors": [
        { "original": "error", "correction": "fix", "explanation_en": "reason" }
      ]
    }
  `;

  try {
    const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=${API_KEY}`, {
      method: 'POST', 
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });
    
    const d = await r.json(); 
    const cleanJson = d.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
    const j = JSON.parse(cleanJson);
    
    document.getElementById('exerciseArea').style.display = 'none'; 
    document.getElementById('result').style.display = 'block';
    document.getElementById('userResponseText').innerText = t;
    
    const s = document.getElementById('scoreDisplay');
    s.innerText = `Score: ${j.score}%`;
    s.style.color = j.score >= 85 ? "#166534" : (j.score >= 50 ? "#ca8a04" : "#991b1b");

    document.getElementById('fbES').innerText = "üáÆüáπ " + j.feedback_it; 
    document.getElementById('fbEN').innerText = "üá¨üáß " + j.feedback_en;
    
    const l = document.getElementById('errorsList'); 
    l.innerHTML = "";
    
    if(j.errors && j.errors.length > 0) {
        j.errors.forEach(e => { 
            l.innerHTML += `<div class="error-item"><span style="text-decoration: line-through;">${e.original}</span> ‚û°Ô∏è <b>${e.correction}</b> (üí° ${e.explanation_en})</div>`; 
        });
    } else {
        l.innerHTML = "<div style='color:#166534; font-weight:bold;'>‚úÖ Benissimo! No significant errors.</div>";
    }

    const btnReset = document.getElementById('btnReset');
    if (isMockExam) {
        if (mockIndex < 4) {
            btnReset.innerText = "‚û°Ô∏è Next Question";
            btnReset.onclick = nextMockQuestion; 
        } else {
            btnReset.innerText = "üèÅ Finish Exam";
            btnReset.onclick = resetApp; 
        }
    } else {
        btnReset.innerText = "üîÑ Try another topic";
        btnReset.onclick = resetApp;
    }

  } catch (e) { 
    console.error(e);
    alert("Error communicating with AI evaluator."); 
  } finally { 
    b.disabled = false; 
    b.innerText = "‚ú® Evaluate Answer"; 
  }
}

// ===========================================
// PARTE 2: ROLEPLAYS (SIN MP3 - TEXT TO SPEECH)
// ===========================================
let rpActual = null; 
let pasoActual = 0; 
let speaking = false;

// Base de Datos RP (OFICIAL LEAVING CERT 2024-2028)
const RP_DB = {
    1: { 
        context: "Un problema in albergo. (A problem at the hotel). You booked a room in Milan but they have no record.", 
        dialogs: [
            "Buongiorno, benvenuto all'Hotel Milano. Come posso aiutarla?", 
            "Mi dispiace, signore. Ho controllato il computer ma non risulta nessuna prenotazione a suo nome.", 
            "Capisco che √® arrabbiato, ma purtroppo siamo al completo stasera.", 
            "S√¨, conosco un albergo qui vicino. Si chiama Hotel Stella. Vuole che chiami per vedere se hanno posto?", 
            ["Ho chiamato l'Hotel Stella e hanno una camera libera. Ho prenotato a suo nome.", "√à tutto risolto. L'Hotel Stella la aspetta."]
        ], 
        sugerencias: [
            "Buongiorno. Mi chiamo [Nome] e ho una prenotazione per una camera doppia per tre notti.", 
            "Non √® possibile! Sono scioccato. Ho prenotato su internet un mese fa e ho la conferma.", 
            "√à un disastro! √à essenziale per me stare in questa zona perch√© ho delle riunioni di lavoro importanti qui vicino.", 
            "S√¨, per favore. Sarebbe molto gentile se potesse prenotare una camera per me l√¨.", 
            "Grazie mille per il suo aiuto. √à stato gentilissimo. Arrivederci." 
        ] 
    },
    2: { 
        context: "Una multa sul treno. (A fine on the train). Florence to Venice. Ticket not validated.", 
        dialogs: [
            "Buongiorno. Biglietto, prego.", 
            "Signore, questo biglietto non √® convalidato. Devo farle la multa.", 
            "Mi dispiace, ma le regole sono regole. La multa √® di cinquanta euro. Deve pagare ora.", 
            "Se non ha contanti, posso darle un bollettino postale. Ha altre domande sul viaggio?", 
            ["S√¨, deve convalidare il biglietto ogni volta che cambia treno.", "Esatto. Ricordi sempre di timbrare prima di salire."]
        ], 
        sugerencias: [
            "Buongiorno. Ecco il mio biglietto.", 
            "Mi scusi, mi dispiace molto! Non l'ho convalidato perch√© ero in ritardo e stavo per perdere il treno. Per favore, non mi faccia la multa.", 
            "Cinquanta euro? Non ho abbastanza soldi con me. Posso pagare con la carta o ricevere la multa per posta?", 
            "Va bene. Senta, devo convalidare il biglietto anche quando cambio treno a Bologna?", 
            "Ho capito, grazie per l'informazione. Star√≤ pi√π attento la prossima volta. Arrivederci." 
        ] 
    },
    3: { 
        context: "In farmacia. (At the chemist's). Working in Italy, feeling unwell.", 
        dialogs: [
            "Buongiorno. Dimmi, cosa c'√® che non va?", 
            "Capisco. Da quanto tempo ti senti cos√¨? Hai mangiato qualcosa di strano?", 
            "Sembra un virus. Ti consiglio di prendere queste compresse due volte al giorno e riposare.", 
            "Oh, capisco. Che lavoro farai?", 
            ["Non preoccuparti. Con questa medicina starai meglio in due giorni.", "Bevi molta acqua e starai bene presto. Arrivederci."]
        ], 
        sugerencias: [
            "Buongiorno. Non mi sento bene. Ho mal di stomaco, mal di testa e un po' di febbre.", 
            "Sto male da ieri sera. Forse ho mangiato dei frutti di mare che non erano freschi.", 
            "Grazie. Per quanti giorni devo prendere le compresse? E devo prenderle prima o dopo i pasti?", 
            "√à molto importante per me guarire presto perch√© inizio il mio lavoro estivo come cameriere la settimana prossima.", 
            "Va bene, grazie mille per i consigli dottore. Arrivederci." 
        ] 
    },
    4: { 
        context: "Dov'√® il passaporto? (Where is my passport?). At Fiumicino airport, lost passport. Calling host family.", 
        dialogs: [
            "Pronto, casa Rossi. Chi parla?", 
            "Oh no! Sei sicuro? Dove l'hai visto l'ultima volta?", 
            "Aspetta un attimo, vado a controllare... (Pausa)... S√¨! L'ho trovato! Era proprio l√¨.", 
            "Certo! Prendo subito un taxi e te lo porto all'aeroporto. Arrivo tra mezz'ora.", 
            ["Non preoccuparti per il taxi. L'importante √® che tu riesca a partire.", "Figurati! Corro subito. A dopo!"]
        ], 
        sugerencias: [
            "Pronto Maria? Sono io. Sono all'aeroporto in fila per il check-in e mi sono accorto di non avere il passaporto!", 
            "L'ultima volta l'ho visto stamattina sul comodino accanto al letto. Per favore, puoi controllare se √® l√¨?", 
            "Che sollievo! Sono contentissimo. Devo assolutamente tornare in Irlanda oggi per un esame domani.", 
            "Grazie mille! Ti pago io il taxi, naturalmente. Ci vediamo agli arrivi?", 
            "Grazie infinite Maria, mi hai salvato la vita! A tra poco." 
        ] 
    },
    5: { 
        context: "Un colloquio di lavoro. (A job interview). Tourist village in Puglia. Interview with Manager.", 
        dialogs: [
            "Buongiorno, prego si accomodi. Mi dica, come si chiama e quanti anni ha?", 
            "Bene. Vedo dal curriculum che ha esperienza. Mi parli del suo lavoro in Irlanda.", 
            "Interessante. E parla molto bene l'italiano! Dove l'ha studiato?", 
            "Molto bravo. Perch√© pensa di essere il candidato ideale per questo lavoro?", 
            ["Ottimo. Ha qualche domanda da farmi sul lavoro?", "Perfetto. Le faremo sapere entro domani. Arrivederci."]
        ], 
        sugerencias: [
            "Buongiorno. Mi chiamo [Nome] e ho diciotto anni.", 
            "S√¨, l'estate scorsa ho lavorato in un campo estivo in Irlanda. Organizzavo giochi e attivit√† sportive per i bambini.", 
            "Studio l'italiano a scuola da cinque anni e guardo molti film italiani per migliorare.", 
            "Sono una persona molto affidabile, socievole e gran lavoratore. Mi piace molto lavorare in squadra.", 
            "S√¨, vorrei sapere quali sono gli orari di lavoro e se c'√® un giorno libero alla settimana. Grazie." 
        ] 
    }
};

function seleccionarRP(id, btn) {
    rpActual = id; pasoActual = 0; speaking = false;
    document.querySelectorAll('.rp-btn-select').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('rpArea').style.display = "block";
    document.getElementById('rpContext').innerHTML = "Situation: " + RP_DB[id].context;
    document.getElementById('rpChat').innerHTML = `<div class="bubble ex"><b>System:</b> Press "Play Examiner Audio" to start.</div>`;
    document.getElementById('nextAudioBtn').style.display = "block";
    document.getElementById('rpInput').disabled = true; document.getElementById('rpSendBtn').disabled = true;
    document.getElementById('hintBtn').style.display = "none";
}

// MODIFICADO: NO USA MP3, USA TTS (Voz Robot)
function reproducirAudio(texto) {
    const u = new SpeechSynthesisUtterance(texto);
    u.lang = 'it-IT'; // Voz Italiana
    u.rate = 0.9;
    u.onend = habilitarInput;
    window.speechSynthesis.speak(u);
}

function habilitarInput() {
    speaking = false;
    if(pasoActual < RP_DB[rpActual].dialogs.length) { 
        document.getElementById('rpInput').disabled = false;
        document.getElementById('rpSendBtn').disabled = false;
        document.getElementById('rpInput').focus();
        document.getElementById('hintBtn').style.display = "block";
        document.getElementById('rpInput').placeholder = "Type your reply...";
    }
}

function proximaIntervencion() {
    if (!rpActual || speaking) return;
    document.getElementById('nextAudioBtn').style.display = "none";
    speaking = true;
    
    if (pasoActual >= 5) {
        document.getElementById('rpChat').innerHTML += `<div class="bubble ex" style="background:#dcfce7; border-color:#86efac;"><b>System:</b> Roleplay Completed! Ben fatto.</div>`;
        return;
    }

    let dialogText = RP_DB[rpActual].dialogs[pasoActual];

    if (Array.isArray(dialogText)) {
        const randomIndex = Math.floor(Math.random() * dialogText.length);
        dialogText = dialogText[randomIndex];
    }

    const chat = document.getElementById('rpChat');
    chat.innerHTML += `<div class="bubble ex"><b>Examiner:</b> ${dialogText}</div>`;
    chat.scrollTop = chat.scrollHeight;
    
    // Aqu√≠ llamamos a la voz sint√©tica en vez del MP3
    reproducirAudio(dialogText);
}

function enviarRespuestaRP() {
    const inp = document.getElementById('rpInput');
    const txt = inp.value.trim(); if(!txt) return;
    const chat = document.getElementById('rpChat');
    chat.innerHTML += `<div class="bubble st">${txt}</div>`;
    chat.scrollTop = chat.scrollHeight;
    inp.value = ""; inp.disabled = true; document.getElementById('rpSendBtn').disabled = true;
    document.getElementById('hintBtn').style.display = "none";
    pasoActual++;
    setTimeout(() => { 
        if(pasoActual < 5) { document.getElementById('nextAudioBtn').style.display = "block"; } else { document.getElementById('rpChat').innerHTML += `<div class="bubble ex" style="background:#dcfce7;"><b>System:</b> Roleplay Completed!</div>`; }
    }, 500);
}

function mostrarSugerencia() {
    const sug = RP_DB[rpActual].sugerencias[pasoActual];
    if(sug) {
        const chat = document.getElementById('rpChat');
        chat.innerHTML += `<div class="feedback-rp">üí° <b>Model Answer:</b> ${sug}</div>`;
        chat.scrollTop = chat.scrollHeight;
    }
}

initConv();

// Funci√≥n ESCUCHAR MI PROPIA RESPUESTA (Italiano)
function readMyInput() {
    const text = document.getElementById("userInput").value;
    if (!text) return; 

    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'it-IT'; // Italiano
    utterance.rate = 0.9;
    window.speechSynthesis.speak(utterance);
}
</script>
<script data-goatcounter="https://lcoralprep.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>
